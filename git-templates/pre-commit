#!/bin/bash

echo "ğŸ” Running TruffleHog on staged files..."

# Get list of staged files (not deleted, text-based)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$|\.js$|\.env$|\.yml$|\.json$|\.txt$')

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No staged files to scan."
    exit 0
fi

CONFIG_PATH="$HOME/.trufflehog/config.json"
EXIT_CODE=0

for FILE in $STAGED_FILES; do  
    if [ -f "$FILE" ]; then
        echo "ğŸ“„ Scanning $FILE ..."
        trufflehog filesystem "$FILE" --fail --json > /dev/null

        if [ $? -ne 0 ]; then
            echo "ğŸš¨ Secrets detected in $FILE"
            EXIT_CODE=1
        fi
    fi
done

if [ $EXIT_CODE -ne 0 ]; then
    echo "âŒ Commit blocked due to detected secrets."
    exit 1
fi

echo "âœ… No secrets found in staged files. Commit allowed."
exit 0
